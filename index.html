<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>USB Lord: Code Mastery Journey</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00ff88">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Courier+Prime:wght@400;700&display=swap');

        :root {
            --primary-color: #00ff88;
            --secondary-color: #00ffff;
            --danger-color: #ff0044;
            --bg-dark: #0a0a0f;
            --bg-panel: rgba(0, 0, 0, 0.9);
            --font-main: 'Orbitron', monospace;
            --font-code: 'Courier Prime', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-dark);
            color: var(--primary-color);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 255, 255, 0.08) 0%, transparent 50%);
            background-size: 50px 50px;
            animation: circuitFlow 30s linear infinite;
            z-index: -1;
        }

        @keyframes circuitFlow {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(10px, 10px);
            }
        }

        .game-container {
            max-width: 100%;
            margin: 0;
            padding: 10px;
        }

        .header,
        .panel,
        .control-panel {
            background: var(--bg-panel);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            padding: 15px;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 900;
            text-shadow: 0 0 15px var(--primary-color);
            margin-bottom: 5px;
            letter-spacing: 2px;
            text-align: center;
        }

        .subtitle {
            color: var(--secondary-color);
            font-size: 0.9rem;
            margin-bottom: 15px;
            text-shadow: 0 0 8px var(--secondary-color);
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .stat-item {
            background: var(--bg-panel);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
        }

        .panel-header {
            padding: 0 0 15px 0;
            border-bottom: 1px solid var(--primary-color);
            margin: -15px -15px 15px -15px;
            padding: 15px;
            background: linear-gradient(45deg, #001a0f, #003322);
        }

        .reasoning-box,
        .hint-box {
            background: rgba(0, 255, 255, 0.1);
            border-left: 4px solid var(--secondary-color);
            padding: 12px 15px;
            margin: 12px 0;
            border-radius: 5px;
            color: var(--secondary-color);
            font-size: 0.85rem;
        }

        .hint-box {
            display: none;
        }

        .code-editor,
        .code-editor:focus {
            background: #000008;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            font-family: var(--font-code);
            font-size: 16px; /* Prevents iOS zoom on focus */
            color: var(--primary-color);
            width: 100%;
            min-height: 120px;
            resize: vertical;
            margin: 12px 0;
            line-height: 1.4;
            outline: none;
        }

        .code-editor:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .btn {
            background: linear-gradient(45deg, #001100, #003300);
            border: 2px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            color: var(--primary-color);
            font-family: var(--font-main);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: linear-gradient(45deg, #000011, #000033);
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        .btn.danger {
            background: linear-gradient(45deg, #110000, #330000);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin: 12px 0;
            font-weight: 700;
            text-align: center;
            animation: feedbackPulse 0.5s ease;
        }

        .feedback.success {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .feedback.error {
            background: rgba(255, 0, 68, 0.2);
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
        }

        .output-terminal {
            background: #000008;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
            font-family: var(--font-code);
            font-size: 0.85rem;
            min-height: 50px;
            color: var(--secondary-color);
        }

        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: #000;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .completed-badge {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid var(--primary-color);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div class="save-indicator" id="saveIndicator">‚ö° STATE SAVED ‚ö°</div>

    <div class="game-container">
        <div class="header">
            <div class="title">üîå USB LORD</div>
            <div class="subtitle">CODE MASTERY JOURNEY</div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">PROTOCOL</div>
                    <div class="stat-value" id="questionNumber">001</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">CHAPTER</div>
                    <div class="stat-value" id="chapterNumber">01</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ACCESS</div>
                    <div class="stat-value" id="score">0000</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">COMPLETE</div>
                    <div class="stat-value" id="completedQuestions">000</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="stat-label">MASTERY PROGRESS</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="btn-group">
                <button class="btn secondary" id="saveBtn">üíæ SAVE</button>
                <button class="btn secondary" id="loadBtn">üìÅ LOAD</button>
                <button class="btn danger" id="resetBtn">üîÑ RESET</button>
            </div>
        </div>

        <div class="panel" id="questionPanel">
            <div class="panel-header">
                <h3 id="questionTitle"></h3>
            </div>
            <div class="panel-content">
                <p id="questionText"></p>
                <div id="reasoningContainer"></div>
                <div class="hint-box" id="hint"></div>
                <textarea class="code-editor" id="codeEditor" placeholder="// Enter your JavaScript commands here..."></textarea>
                <div class="btn-group">
                    <button class="btn" id="runBtn">‚ö° EXECUTE</button>
                    <button class="btn" id="submitBtn">üîç VALIDATE</button>
                    <button class="btn secondary" id="hintBtn">üí° HINT</button>
                    <button class="btn secondary" id="nextBtn" disabled>‚û°Ô∏è NEXT</button>
                </div>
                <div id="feedback"></div>
                <div class="output-terminal" id="output">SYSTEM READY - AWAITING COMMANDS...</div>
            </div>
        </div>
    </div>

    <script>
        // --- SAFE CODE EXECUTION ENGINE ---
        class CodeExecutor {
            static execute(code) {
                try {
                    // Using a function constructor is safer than eval()
                    const func = new Function(code);
                    const result = func();
                    return {
                        success: true,
                        result: result !== undefined ? String(result) : "Execution complete.",
                        output: ""
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }
        }

        // --- LOCAL STORAGE MANAGER ---
        class MobileStorage {
            static save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error("Error saving to localStorage:", error);
                    return false;
                }
            }
            static load(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error("Error loading from localStorage:", error);
                    return null;
                }
            }
            static remove(key) {
                localStorage.removeItem(key);
            }
        }

        // --- GAME CONTENT ---
        const chapters = {
            1: {
                title: "Chapter 01: Basic Protocol Initialization",
                questions: [{
                        text: "Initialize your first system variable. Create a variable called 'usbPort' and assign it the value 'USB001'.",
                        reasoning: "Variables are containers for storing data values. In JavaScript, `let` is used to declare a variable that can be reassigned.",
                        solution: `let usbPort = 'USB001';`,
                        test: (code) => /let\s+usbPort\s*=\s*['"]USB001['"]/.test(code)
                    },
                    {
                        text: "Create a boolean variable 'deviceConnected' and set it to false.",
                        reasoning: "Booleans represent one of two values: true or false. They are perfect for tracking on/off states, like a connection status.",
                        solution: `let deviceConnected = false;`,
                        test: (code) => /let\s+deviceConnected\s*=\s*false/.test(code)
                    }
                    // Add more questions here
                ]
            }
            // Add more chapters here
        };

        // --- CORE GAME LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM ELEMENT REFERENCES ---
            const dom = {
                questionNumber: document.getElementById('questionNumber'),
                chapterNumber: document.getElementById('chapterNumber'),
                score: document.getElementById('score'),
                completedQuestions: document.getElementById('completedQuestions'),
                progressFill: document.getElementById('progressFill'),
                questionTitle: document.getElementById('questionTitle'),
                questionText: document.getElementById('questionText'),
                reasoningContainer: document.getElementById('reasoningContainer'),
                hint: document.getElementById('hint'),
                codeEditor: document.getElementById('codeEditor'),
                feedback: document.getElementById('feedback'),
                output: document.getElementById('output'),
                saveIndicator: document.getElementById('saveIndicator'),
                // Buttons
                saveBtn: document.getElementById('saveBtn'),
                loadBtn: document.getElementById('loadBtn'),
                resetBtn: document.getElementById('resetBtn'),
                runBtn: document.getElementById('runBtn'),
                submitBtn: document.getElementById('submitBtn'),
                hintBtn: document.getElementById('hintBtn'),
                nextBtn: document.getElementById('nextBtn'),
            };

            // --- GAME STATE ---
            let gameState = {
                currentQuestion: 0,
                currentChapter: 1,
                score: 0,
                completed: new Set(),
                totalQuestions: 2 // Manually set for this example
            };

            // --- FUNCTIONS ---
            function updateStats() {
                dom.questionNumber.textContent = String(gameState.currentQuestion + 1).padStart(3, '0');
                dom.chapterNumber.textContent = String(gameState.currentChapter).padStart(2, '0');
                dom.score.textContent = String(gameState.score).padStart(4, '0');
                dom.completedQuestions.textContent = String(gameState.completed.size).padStart(3, '0');
                const progress = Math.max(1, (gameState.completed.size / gameState.totalQuestions) * 100);
                dom.progressFill.style.width = `${progress}%`;
            }

            function displayQuestion() {
                const chapter = chapters[gameState.currentChapter];
                const question = chapter.questions[gameState.currentQuestion];

                if (!question) {
                    console.error("Question not found!");
                    return;
                }

                dom.questionTitle.innerHTML = `${chapter.title} ${gameState.completed.has(gameState.currentQuestion) ? '<span class="completed-badge">‚úÖ</span>' : ''}`;
                dom.questionText.textContent = question.text;
                dom.reasoningContainer.innerHTML = `<div class="reasoning-box">${question.reasoning}</div>`;
                dom.hint.textContent = `üí° HINT: ${question.solution}`;
                dom.hint.style.display = 'none';
                dom.feedback.innerHTML = '';
                dom.output.textContent = 'SYSTEM READY - AWAITING COMMANDS...';
                dom.codeEditor.value = '';
                dom.nextBtn.disabled = !gameState.completed.has(gameState.currentQuestion);
            }

            function runCode() {
                const code = dom.codeEditor.value;
                const result = CodeExecutor.execute(code);
                if (result.success) {
                    dom.output.innerHTML = `<span style="color: #00ff88;">${result.result}</span>`;
                } else {
                    dom.output.innerHTML = `<span style="color: #ff0044;">ERROR: ${result.error}</span>`;
                }
            }

            function submitAnswer() {
                const code = dom.codeEditor.value;
                const question = chapters[gameState.currentChapter].questions[gameState.currentQuestion];

                if (question.test(code)) {
                    if (!gameState.completed.has(gameState.currentQuestion)) {
                        gameState.score += 100;
                        gameState.completed.add(gameState.currentQuestion);
                        dom.feedback.innerHTML = `<div class="feedback success">‚ö° PROTOCOL VALIDATED (+100)</div>`;
                    } else {
                        dom.feedback.innerHTML = `<div class="feedback success">‚úÖ PROTOCOL CONFIRMED</div>`;
                    }
                    dom.nextBtn.disabled = false;
                    saveProgress();
                } else {
                    dom.feedback.innerHTML = `<div class="feedback error">‚ùå VALIDATION FAILED</div>`;
                }
                updateStats();
            }

            function nextQuestion() {
                if (gameState.currentQuestion < gameState.totalQuestions - 1) {
                    gameState.currentQuestion++;
                    displayQuestion();
                    updateStats();
                } else {
                    alert("Congratulations, you have completed all protocols!");
                }
            }

            function showHint() {
                dom.hint.style.display = dom.hint.style.display === 'none' ? 'block' : 'none';
            }

            function saveProgress() {
                MobileStorage.save('usbLordProgress', gameState);
                dom.saveIndicator.classList.add('show');
                setTimeout(() => dom.saveIndicator.classList.remove('show'), 2000);
            }

            function loadProgress() {
                const savedState = MobileStorage.load('usbLordProgress');
                if (savedState) {
                    // Restore Set from array
                    savedState.completed = new Set(Array.from(savedState.completed));
                    gameState = savedState;
                    alert('‚ö° Progress Restored!');
                    displayQuestion();
                    updateStats();
                } else {
                    alert('‚ùå No saved progress found.');
                }
            }

            function resetProgress() {
                if (confirm('‚ö†Ô∏è Are you sure you want to reset all progress?')) {
                    MobileStorage.remove('usbLordProgress');
                    // Re-initialize state
                    gameState = {
                        currentQuestion: 0,
                        currentChapter: 1,
                        score: 0,
                        completed: new Set(),
                        totalQuestions: 2
                    };
                    displayQuestion();
                    updateStats();
                }
            }

            // --- EVENT LISTENERS ---
            dom.runBtn.addEventListener('click', runCode);
            dom.submitBtn.addEventListener('click', submitAnswer);
            dom.nextBtn.addEventListener('click', nextQuestion);
            dom.hintBtn.addEventListener('click', showHint);
            dom.saveBtn.addEventListener('click', saveProgress);
            dom.loadBtn.addEventListener('click', loadProgress);
            dom.resetBtn.addEventListener('click', resetProgress);

            // --- INITIALIZE GAME ---
            loadProgress(); // Try to load saved data first
            displayQuestion();
            updateStats();
        });
    </script>
</body>

</html>
